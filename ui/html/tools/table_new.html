<!DOCTYPE html>
<!--
  Copyright 2011 Google Inc. All Rights Reserved.

  Licensed under the Apache License; Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing; software
  distributed under the License is distributed on an "AS IS" BASIS;
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND; either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <style>

        #ft-data{
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13px;
        }

        th {
            position: sticky;
            background-color: white;
            z-index: 2;
            top: 0;
            padding: 0.2em 0;
            font-size: 1.2em;
        }

        tr {
            xxborder: solid #dddddd 1px;
        }

        .td_yellow {
            background: rgba(255, 255, 0, 0.1);
        }

        .td_red {
            background: rgba(255, 0, 0, 0.1);
        }

        .td_blue {
            background: rgba(0, 0, 255, 0.05);
        }

        .td_green {
            background: rgba(0, 255, 0, 0.05);
        }

        .td_right {
            text-align: end;
        }

        .even {
            background: #EDF2FA;
            background: #ffffff;
            background: #F4F5F6;
        }

        a {
            color: #428BCA;
            text-decoration: none;
        }

        .wrapword {
            white-space: -moz-pre-wrap !important;
            /* Mozilla, since 1999 */
            white-space: -pre-wrap;
            /* Opera 4-6 */
            white-space: -o-pre-wrap;
            /* Opera 7 */
            white-space: pre-wrap;
            /* css-3 */
            word-wrap: break-word;
            /* Internet Explorer 5.5+ */
            white-space: -webkit-pre-wrap;
            /* Newer versions of Chrome/Safari*/
            word-break: break-all;
            white-space: normal;
        }

        .data-body {
            border-top: #cccccc solid 1px;
        }

    </style>

<head>
    <meta charset="UTF-8">

    <title>iXmaps Editor Table Viewer</title>


     <script type="text/javascript">
        
        ixmaps = window.ixmaps || null;
        if ( window.opener ){
            ixmaps = window.opener.ixmaps;
        }else
        if ( parent ){
            ixmaps = parent.window.ixmaps;
        }
        else{
            alert("error: missing parent window for themes !");
        }
        
        ixmaps.tmp = ixmaps.tmp || {};

        ixmaps.__showTable = function(){
            // Set flag to prevent $(document).ready() from initializing again
            window.__tableInitializedManually = true;
            
            const data = dataSinks.add(ixmaps.tmp.tableObj,"mytable");
            data.fShowAnalytics = true;
            
            // Set map property if theme is associated
            try {
                // Try to get map from various locations
                let map = null;
                
                // Try Chat app context first (embeddedSVG.window.map)
                if (ixmaps.embeddedSVG && ixmaps.embeddedSVG.window && ixmaps.embeddedSVG.window.map) {
                    map = ixmaps.embeddedSVG.window.map;
                } 
                // Try window.map
                else if (window.map) {
                    map = window.map;
                } 
                // Try ixmaps.getMap function
                else if (typeof ixmaps.getMap === 'function') {
                    map = ixmaps.getMap();
                }
                // Try to get from theme if available
                else if (ixmaps.tmp && ixmaps.tmp.themeId) {
                    try {
                        const themeId = ixmaps.tmp.themeId;
                        if (typeof ixmaps.getThemeObj === 'function') {
                            const themeObj = ixmaps.getThemeObj(themeId);
                            if (themeObj && themeObj.map) {
                                map = themeObj.map;
                            }
                        }
                    } catch (e) {
                        // Ignore errors
                    }
                }
                // Try to get from last theme
                else if (typeof ixmaps.getThemes === 'function') {
                    try {
                        const themes = ixmaps.getThemes();
                        if (themes && themes.length > 0) {
                            const themeObj = themes[themes.length - 1];
                            if (themeObj && themeObj.map) {
                                map = themeObj.map;
                            }
                        }
                    } catch (e) {
                        // Ignore errors
                    }
                }
                
                if (map) {
                    data.map = map;
                    // Also store themeId if available
                    if (ixmaps.tmp && ixmaps.tmp.themeId) {
                        data.themeId = ixmaps.tmp.themeId;
                        console.log('[MAP ROLES] Map and themeId associated with DataSink:', data.themeId);
                    } else {
                        // Try to get themeId from last theme
                        try {
                            if (typeof ixmaps.getThemes === 'function') {
                                const themes = ixmaps.getThemes();
                                if (themes && themes.length > 0) {
                                    const themeObj = themes[themes.length - 1];
                                    data.themeId = themeObj.id || themeObj.szId || themeObj.szThemeId || null;
                                    if (data.themeId) {
                                        console.log('[MAP ROLES] Map and themeId (from last theme) associated with DataSink:', data.themeId);
                                    }
                                }
                            }
                        } catch (e) {
                            // Ignore errors
                        }
                        if (!data.themeId) {
                            console.log('[MAP ROLES] Map associated with DataSink (no themeId)');
                        }
                    }
                } else {
                    console.warn('[MAP ROLES] Could not find map instance');
                }
            } catch (e) {
                console.warn('[MAP ROLES] Could not set map property:', e);
            }
            
            const html = data.makeDataTable(500);
            
            $('#ft-data-name').html("");
            $('#ft-data').html(html);
            
            // Set up event listeners for the table
            data.setupTableEventListeners(data.name);
            
            // Clear the flag after use
            if (ixmaps.tmp && ixmaps.tmp.usePreparedTable) {
                delete ixmaps.tmp.usePreparedTable;
            }
        }

        $(document).ready(function() {
            // Skip automatic initialization if __showTable was already called manually
            // This prevents double initialization when loaded dynamically in Chat app
            if (window.__tableInitializedManually || window.__skipTableAutoInit) {
                window.__tableInitializedManually = false; // Reset flag
                window.__skipTableAutoInit = false; // Reset flag
                return;
            }
            
            // Check if a prepared table object already exists (e.g., from AI query)
            if (ixmaps.tmp && ixmaps.tmp.tableObj && ixmaps.tmp.usePreparedTable) {
                // Use the prepared table object instead of getting the last theme
                let tableObj = ixmaps.tmp.tableObj;
                let numRows = tableObj.records ? tableObj.records.length : (tableObj.table ? tableObj.table.records : 0);
                $('#ft-data-name').html(String(numRows) + " records <span style='font-size:smaller'>(please give me some time ...)</span>");
                
                const _fileUrls = [
                    {
                        url: 'ui/js/tools/dataprocess.js',
                        type: 'js'
                    },
                    {
                        url: 'ui/js/tools/datafacets.js',
                        type: 'js'
                    }
                ];
                // this loads the resources and calls ixmaps.loadEditor as callback
                ixmaps.loadResources(_fileUrls, null, ixmaps.__showTable);
                return; // Exit early, don't process default theme
            }
            
            // Default behavior: get the last theme
            let themeObj = ixmaps.getThemes().at(-1);
            let tableObj = new Data.Table(null);
            tableObj.table = themeObj.objTheme.dbTable;
            tableObj.fields = themeObj.objTheme.dbFields;
            tableObj.records = themeObj.objTheme.dbRecords;
            ixmaps.tmp.tableObj = tableObj;

            // GR 23.02.2018 show only rows which are on the map
            // -------------------------------------------------
            var records = [];
            for ( i in themeObj.indexA ){
                if ( themeObj.itemA[themeObj.indexA[i]].dbIndex ){
                    records.push(tableObj.records[themeObj.itemA[themeObj.indexA[i]].dbIndex]);
                }
                if ( themeObj.itemA[themeObj.indexA[i]].dbIndexA ){
                    for ( a in themeObj.itemA[themeObj.indexA[i]].dbIndexA ) {
                        records.push(tableObj.records[themeObj.itemA[themeObj.indexA[i]].dbIndexA[a]]);
                    }
                }
            }
            tableObj.records = records;

            let numRows = tableObj.table.records;
            $('#ft-data-name').html(String(numRows) + " records <span style='font-size:smaller'>(please give me some time ...)</span>");
            
            const _fileUrls = [
            {
                    url: 'ui/js/tools/dataprocess.js',
                    type: 'js'
                },
                {
                    url: 'ui/js/tools/datafacets.js',
                    type: 'js'
                }
            ];
            // this loads the resources and calls ixmaps.loadEditor as callback
            ixmaps.loadResources(_fileUrls, null, ixmaps.__showTable);
            var resize = function(resizeData){
                $("#ft-data").css("height",(resizeData.height)+"px");
                $("#ft-data").css("width",(resizeData.width)+"px");
                // set dialog iframe height
                if ( ixmaps && ixmaps.editor && ixmaps.editor.resize ){
                    ixmaps.editor.resize();
                }
            }; 
            
            // Setup dialog resize handling
            var setupDialogResizeHandler = function(){
                // Try to find the dialog instance and set up resize callback
                if (window.parent && window.parent.dialogManager) {
                    // Find the current dialog (assuming it's the most recently created one)
                    var openDialogs = window.parent.dialogManager.getOpenDialogs();
                    if (openDialogs.length > 0) {
                        var currentDialog = openDialogs[openDialogs.length - 1];
                        currentDialog.setOnResize(function(resizeData) {
                            console.log('Dialog resized:', resizeData);
                            resize(resizeData); // Call your existing resize function
                        });
                        console.log("Dialog resize handler activated");
                    }
                }
            };
            
            // Setup dialog resize handler after DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupDialogResizeHandler);
            } else {
                setupDialogResizeHandler();
            }


        });

    </script>
</head>

<body style="padding:0;margin:0;">
    <div id="ft-data" style="margin:0px;padding:0px;overflow:auto"> L o a d i n g . . . </div>
    <div id="ft-data-name" class="ftdataname"></div>
</body>

</html>
