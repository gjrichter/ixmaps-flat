<!DOCTYPE html>
<!--
  theme_facets.html — Facet filter UI for a map theme.
  Shows categorical/range facets for the current theme; user can filter by value,
  toggle "active" vs "all" facets, and switch "by counts" vs "by values".
  Requires ixmaps API from parent/opener; loads facet.js, show_facets.js, etc.
-->
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	<meta http-equiv="Content-Language" content="en-us" />
	<meta name="copyright" content="Guenter Richter" />
	<meta name="author" content="service@medienobjekte.de" />
	<meta name="description" content="Interactive &amp; extensible maps in SVG — theme facet filter" />
	<meta name="revisit-after" content="30 days" />
	<meta name="distribution" content="Global" />

	<!-- Bootstrap slider for range facets -->
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.9.0/css/bootstrap-slider.min.css" />


	<style>
		/* Tables: facet value lists */
		table {
			background: #F7F6EF;
			border-radius: 0.3em;
		}

		td {
			border: dotted #888800 0.1px;
		}

		/* Buttons: active/all, by counts/values */
		button {
			background: none;
			border: #dddddd solid 1px;
			border-radius: 0.3em;
			padding: 0.4em 0.8em;
		}

		button:hover {
			cursor: pointer;
		}

		.btn {
			background: none;
			border: #dddddd solid 1px;
			border-radius: 0.3em;
			padding: 0.4em 0.8em;
			color: #444444;
		}

		.btn:hover {
			background: #f8f8f8;
			border: #dddddd solid 1px;
			border-radius: 0.3em;
			padding: 0.4em 0.8em;
			color: #444444;
		}

		.btn-block,
		.btn-primary {
			background: none;
			border: #dddddd solid 1px;
			border-radius: 0.3em;
			padding: 0.4em 0.8em;
		}

		.badge,
		.badge-primary,
		.badge-pill {
			background: none;
			color: #444444;
			font-weight: normal;
		}

		.left {
			text-align: left;
		}

		a {
			text-decoration: none;
		}
	</style>
	<style type="text/css">
		/* Typography */
		h1,
		h2,
		h3,
		h4,
		h5,
		h6 {
			font-family: arial, helvetica;
			color: #888;
			font-weight: 300;
		}

		p {
			font-family: arial, helvetica;
			color: #444;
			font-weight: 300;
		}

		a {
			font-family: arial, helvetica;
			font-weight: 100;
			color: black;
			text-decoration: none;
		}

		a:hover {
			color: #000088;
			text-decoration: none;
		}

		/* Facet filter search input */
		.filter-input {
			width: 275px;
			margin: 0;
			float: left;
			outline: none;
			font-size: 1.2em;
			border: 0;
			margin-left: 0.2em;
			font-family: Raleway, Arial;
			font-weight: 300;
			color: #444;
		}

		/* Range slider labels */
		.minvalue,
		.maxvalue {
			margin-left: 1em;
			margin-right: 1em;
		}

		/* Bootstrap-slider handle override */
		.slider-handle {
			position: absolute;
			top: 0px;
			width: 20px;
			height: 20px;
			background-color: #ddd;
			background-image: none;
			filter: none;
			box-shadow: rgba(255, 255, 255, 0.2) 0px 1px 0px inset, rgba(0, 0, 0, 0.05) 0px 1px 2px;
			background-repeat: repeat-x;
			border-width: 0px;
			border-style: solid;
			border-color: transparent;
			border-image: initial;
		}
	</style>

</head>

<body style="margin:0px;padding:0px;">

	<!-- Main container: toolbar + facet list (filled by makeFacets / showFacets) -->
	<div id="container" style="padding:2.5em 1em;vertical-align:middle;background-color:rgba(255,255,255,0.9);">

		<!-- Toggle which facets are visible: only those with active filter, or all -->
		<div class="btn-group" style="margin-top:0.8em;margin-bottom:0em;">
			<button id="btn-only-active" type="button" class="btn btn-default"
				onclick="$('.facet').hide();">active</button>
			<button id="btn-all" type="button" class="btn btn-default" onclick="$('.facet').show();">all</button>
		</div>
		<!-- Toggle facet list display: by counts vs by values (shown when facets support it) -->
		<div id="facets-counts-values" class="btn-group" style="margin-top:0.8em;margin-bottom:0em;display:none">
			<button id="btn-count" type="button" class="btn btn-default"
				onclick="ixmaps.data.fShowFacetValues = false;ixmaps.htmlgui_onZoomAndPan()">by counts</button>
			<button id="btn-values" type="button" class="btn btn-default"
				onclick="ixmaps.data.fShowFacetValues = true;ixmaps.htmlgui_onZoomAndPan()">by values</button>
		</div>

		<!-- Facet list placeholder; replaced by makeFacets/showFacets (or "generating facets..." until ready) -->
		<div id="facetDiv" style="margin-bottom:1em;width:100%">
			<h2 style="padding:0.2em 0.5em;background:#dddddd;border-radius:5px;color:white">generating facets ...<img
					src="https://gjrichter.github.io/ixmaps_flat/ui/resources/images/loading_blue.gif"
					style="display:block;margin:0.2em auto;height:64px" alt=""></h2>
		</div>

	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.9.0/bootstrap-slider.min.js"></script>

	<script type="text/javascript">

		// -----------------------------------------------------------------------
		// Resolve ixmaps API from parent window (iframe) or opener (popup).
		// Required for theme data and map API (changeThemeStyle, etc.).
		// -----------------------------------------------------------------------
		ixmaps = window.ixmaps || null;
		if (window.opener) {
			ixmaps = window.opener.ixmaps;
		} else if (parent && parent.window && parent.window.ixmaps) {
			ixmaps = parent.window.ixmaps;
		}
		if (!ixmaps) {
			alert("Error: theme_facets requires the map window (parent or opener). Load this page inside the map UI.");
		}
		ixmaps.initialized = true;

		ixmaps.data = ixmaps.data || {};
		/** true = show facet values in list; false = show counts (e.g. for numeric bins) */
		ixmaps.data.fShowFacetValues = true;

		/**
		 * Build and display facets for the current theme (ixmaps.data.szThemeId).
		 * Ensures theme is categorical/ranges, reads filter from theme definition,
		 * calls getFacets (facet.js) and showFacets (show_facets.js) to fill #facetDiv.
		 */
		ixmaps.data.makeFacets = function () {
			var objTheme = ixmaps.getThemeObj(ixmaps.data.szThemeId);
			if (!objTheme) {
				$("#container").html("<h3 style='margin-top:-0.5em'>No data to create facets!</h3><p>Please go back to 'Configure' and load some data or a project!</p>");
				return;
			}

			// Ensure theme supports categorical/ranges for faceting
			if (!objTheme.szFlag.match(/CATEGORICAL/)) {
				ixmaps.changeThemeStyle(null, objTheme.szId, "type:RANGES", "add");
			}

			var objThemeDefinition = ixmaps.getThemeDefinitionObj(ixmaps.data.szThemeId);
			if (!objThemeDefinition) {
				$("#facetDiv").html("<h3>No theme definition to filter.</h3>");
				return;
			}

			// Normalize filter: theme definition may have filter as string or array of clauses
			var szFilter = objThemeDefinition.style.filter || " ";
			if (Array.isArray(szFilter)) {
				szFilter = szFilter.length ? ('WHERE ' + szFilter.map(function (p) { return String(p).trim(); }).filter(Boolean).join(' AND ')) : " ";
			} else if (typeof szFilter !== 'string') {
				szFilter = szFilter != null ? String(szFilter) : " ";
			}

			var szId = ixmaps.data.szThemeId;
			var facetsA = ixmaps.data.getFacets(szFilter.replace(/\'/g, "\\'"), 'user_legend', null, szId, "map", "NONUMERIC");
			ixmaps.data.showFacets(szFilter, "facetDiv", facetsA);
			$("#facetDiv").show();
		};

		// -----------------------------------------------------------------------
		// Hook map zoom/pan and theme redraw so facets refresh (e.g. viewport change).
		// Defined here so shared/exported maps keep facet behaviour.
		// -----------------------------------------------------------------------
		var old_onZoomAndPan = ixmaps.htmlgui_onZoomAndPan;
		var old_onDrawTheme = ixmaps.htmlgui_onDrawTheme;

		ixmaps.data._makeFacetsDebounceTimer = null;
		ixmaps.data._makeFacetsDebounceMs = 150;

		ixmaps.htmlgui_onZoomAndPan = function () {
			if (ixmaps.data._makeFacetsDebounceTimer) clearTimeout(ixmaps.data._makeFacetsDebounceTimer);
			ixmaps.data._makeFacetsDebounceTimer = setTimeout(function () {
				ixmaps.data._makeFacetsDebounceTimer = null;
				ixmaps.data.makeFacets();
			}, ixmaps.data._makeFacetsDebounceMs);
			if (old_onZoomAndPan) old_onZoomAndPan();
		};

		ixmaps.htmlgui_onDrawTheme = function (szId) {
			ixmaps.data.makeFacets();
			if (old_onDrawTheme) old_onDrawTheme(szId);
		};

		// Load facet tools then pick first non-FEATURE theme and build facets
		$.when(
			$.getScript(ixmaps.szResourceBase + "ui/js/tools/facet.js"),
			$.getScript(ixmaps.szResourceBase + "ui/js/tools/show_facets.js"),
			$.getScript(ixmaps.szResourceBase + "ui/js/tools/show_word_cloud.js"),
			$.getScript(ixmaps.szResourceBase + "ui/js/tools/format.js"),
			$.Deferred(function (deferred) { $(deferred.resolve); })
		).done(function () {

			if (!ixmaps.data.szThemeId) {
				// Default to first data theme (skip FEATURE-only themes) if none set (e.g. by Chat)
				var themes = ixmaps.getThemes();
				for (var i in themes) {
					if (!themes[i].szFlag.match(/FEATURE/)) {
						ixmaps.data.szThemeId = themes[i].szId;
						break;
					}
				}
			}
			ixmaps.data.makeFacets();
		});

	</script>
</body>

</html>